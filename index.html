<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BMI Health Tracker</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for Inter font and general body styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            box-sizing: border-box;
        }
        /* Ensure the main container grows to fill available space on smaller screens */
        .container {
            max-width: 90%;
            width: 100%;
        }
        /* Styling for the health tracker history table */
        .history-table th, .history-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0; /* Light gray border */
        }
        .history-table th {
            background-color: #edf2f7; /* Lighter gray for table headers */
        }
        /* Basic spinner for loading indicator */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6; /* Blue-600 */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Style for the delete button in the table */
        .delete-btn {
            background-color: #ef4444; /* Red-500 */
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 0.375rem; /* rounded-md */
            font-size: 0.75rem; /* text-xs */
            line-height: 1;
            transition: background-color 0.2s ease-in-out;
            margin-right: 0.5rem; /* Space between buttons */
        }
        .delete-btn:hover {
            background-color: #dc2626; /* Red-600 */
        }
        /* Style for the health guide button in the table */
        .guide-btn {
            background-color: #4CAF50; /* Green color */
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 0.375rem; /* rounded-md */
            font-size: 0.75rem; /* text-xs */
            line-height: 1;
            transition: background-color 0.2s ease-in-out;
        }
        .guide-btn:hover {
            background-color: #45a049; /* Darker green */
        }

        /* Modal specific styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent black background */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Ensure it's on top of other content */
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem; /* rounded-lg */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-xl */
            max-width: 28rem; /* max-w-md */
            width: 90%; /* Responsive width */
            position: relative;
        }
        .modal-close-btn {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #4a5568; /* Gray-700 */
        }
        .modal-close-btn:hover {
            color: #2d3748; /* Gray-900 */
        }
        /* Style for the "View More/Less" button */
        .view-toggle-btn {
            background-color: #60a5fa; /* Blue-400 */
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 0.375rem; /* rounded-md */
            font-size: 0.875rem; /* text-sm */
            transition: background-color 0.2s ease-in-out;
            margin-top: 1rem;
        }
        .view-toggle-btn:hover {
            background-color: #3b82f6; /* Blue-500 */
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="container bg-white p-8 rounded-xl shadow-lg flex flex-col md:flex-row gap-8">
        <!-- BMI Calculator Section -->
        <div class="flex-1 p-6 bg-blue-50 rounded-lg shadow-inner">
            <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">BMI Health Tracker</h1>
            <div class="text-center text-gray-600 text-sm mb-6">Developed by S R Software Studio</div>

            <!-- Name Input -->
            <div class="mb-4">
                <label for="userName" class="block text-gray-700 text-sm font-semibold mb-2">Name:</label>
                <input type="text" id="userName" placeholder="e.g., John Doe"
                       class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200">
            </div>

            <!-- Age Input -->
            <div class="mb-4">
                <label for="userAge" class="block text-gray-700 text-sm font-semibold mb-2">Age:</label>
                <input type="number" id="userAge" placeholder="e.g., 30"
                       class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200"
                       min="1" max="120" step="1">
            </div>

            <!-- Height Unit Selection -->
            <div class="mb-4">
                <label for="heightUnit" class="block text-gray-700 text-sm font-semibold mb-2">Height Unit:</label>
                <select id="heightUnit" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200">
                    <option value="cm">Centimeters (cm)</option>
                    <option value="ft-in">Feet & Inches (ft/in)</option>
                </select>
            </div>

            <!-- Height Input - Centimeters -->
            <div id="heightCmContainer" class="mb-4">
                <label for="heightCm" class="block text-gray-700 text-sm font-semibold mb-2">Height (cm):</label>
                <input type="number" id="heightCm" placeholder="e.g., 175"
                       class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200"
                       min="1" step="0.1">
            </div>

            <!-- Height Input - Feet & Inches (initially hidden) -->
            <div id="heightFtInContainer" class="mb-4 hidden">
                <div class="mb-4">
                    <label for="heightFt" class="block text-gray-700 text-sm font-semibold mb-2">Feet:</label>
                    <input type="number" id="heightFt" placeholder="e.g., 5"
                           class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200"
                           min="0" step="1">
                </div>
                <div class="mb-4">
                    <label for="heightIn" class="block text-gray-700 text-sm font-semibold mb-2">Inches:</label>
                    <input type="number" id="heightIn" placeholder="e.g., 10"
                           class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200"
                           min="0" max="11" step="0.1">
                </div>
            </div>

            <div class="mb-6">
                <label for="weight" class="block text-gray-700 text-sm font-semibold mb-2">Weight (kg):</label>
                <input type="number" id="weight" placeholder="e.g., 70"
                       class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent transition duration-200"
                       min="1" step="0.1">
            </div>

            <button id="calculateBtn"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-300 transform hover:scale-105 shadow-md">
                Calculate BMI
            </button>

            <!-- The result div is now permanently hidden from the main view -->
            <div id="result" class="mt-8 p-4 bg-blue-100 border border-blue-200 rounded-lg text-center hidden">
                <p class="text-lg font-semibold text-gray-800 mb-2">Your BMI: <span id="bmiValue" class="text-blue-700 text-xl"></span></p>
                <p class="text-md text-gray-700">Category: <span id="bmiCategory" class="font-bold"></span></p>
            </div>

            <div id="messageBox" class="mt-4 p-3 bg-red-100 border border-red-200 text-red-700 rounded-lg hidden">
                Please enter valid numbers for height and weight.
            </div>
        </div>

        <!-- Health Tracker Section -->
        <div class="flex-1 p-6 bg-green-50 rounded-lg shadow-inner">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Health Tracker History</h2>
            <div id="historyList" class="overflow-x-auto">
                <table class="min-w-full bg-white rounded-lg shadow-sm history-table">
                    <thead>
                        <tr>
                            <th class="py-3 px-4 text-gray-600 uppercase text-sm font-semibold">Date</th>
                            <th class="py-3 px-4 text-gray-600 uppercase text-sm font-semibold">Name</th>
                            <th class="py-3 px-4 text-gray-600 uppercase text-sm font-semibold">Age</th>
                            <th class="py-3 px-4 text-gray-600 uppercase text-sm font-semibold">Height</th>
                            <th class="py-3 px-4 text-gray-600 uppercase text-sm font-semibold">Weight (kg)</th>
                            <th class="py-3 px-4 text-gray-600 uppercase text-sm font-semibold">BMI</th>
                            <th class="py-3 px-4 text-gray-600 uppercase text-sm font-semibold">Category</th>
                            <th class="py-3 px-4 text-gray-600 uppercase text-sm font-semibold">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <!-- History entries will be inserted here by JavaScript -->
                        <tr id="noHistoryMessage">
                            <td colspan="8" class="text-center py-4 text-gray-500">No history yet. Calculate your BMI to add an entry!</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <button id="clearHistoryBtn"
                    class="mt-6 w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-50 transition duration-300 transform hover:scale-105 shadow-md">
                Clear All History
            </button>
        </div>
    </div>

    <!-- Health Guide Modal -->
    <div id="healthGuideModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button id="closeModalBtn" class="modal-close-btn">&times;</button>
            <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Personalized Health Guide</h3>
            <div id="modalHealthGuideContent" class="text-gray-700 text-base">
                <!-- Health guide will be generated here -->
            </div>
            <div id="modalHealthGuideLoading" class="flex justify-center items-center mt-4 hidden">
                <div class="spinner"></div>
                <span class="ml-2 text-gray-600">Generating guide...</span>
            </div>
            <button id="viewToggleBtn" class="view-toggle-btn hidden">View More</button>
        </div>
    </div>

    <script>
        // Get references to HTML elements
        const userNameInput = document.getElementById('userName');
        const userAgeInput = document.getElementById('userAge');
        const heightUnitSelect = document.getElementById('heightUnit');
        const heightCmContainer = document.getElementById('heightCmContainer');
        const heightFtInContainer = document.getElementById('heightFtInContainer');
        const heightCmInput = document.getElementById('heightCm');
        const heightFtInput = document.getElementById('heightFt');
        const heightInInput = document.getElementById('heightIn');
        const weightInput = document.getElementById('weight');
        const calculateBtn = document.getElementById('calculateBtn');
        const resultDiv = document.getElementById('result'); // Still referenced, but its display is controlled
        const bmiValueSpan = document.getElementById('bmiValue');
        const bmiCategorySpan = document.getElementById('bmiCategory');
        const messageBox = document.getElementById('messageBox');
        const historyTableBody = document.getElementById('historyTableBody');
        const noHistoryMessage = document.getElementById('noHistoryMessage');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');

        // Modal elements
        const healthGuideModal = document.getElementById('healthGuideModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const modalHealthGuideContent = document.getElementById('modalHealthGuideContent');
        const modalHealthGuideLoading = document.getElementById('modalHealthGuideLoading');
        const viewToggleBtn = document.getElementById('viewToggleBtn'); // New button for view more/less

        // Constants for truncation
        const TRUNCATE_LENGTH = 200; // Number of characters to show initially

        // Variable to store the full text of the health guide
        let fullHealthGuideText = '';

        // Key for storing BMI history in localStorage
        const STORAGE_KEY = 'bmiHistory';

        /**
         * Calculates the Body Mass Index (BMI).
         * @param {number} weightKg - Weight in kilograms.
         * @param {number} heightCm - Height in centimeters.
         * @returns {number} The calculated BMI.
         */
        function calculateBMI(weightKg, heightCm) {
            const heightMeters = heightCm / 100; // Convert cm to meters
            return weightKg / (heightMeters * heightMeters);
        }

        /**
         * Determines the BMI category based on the calculated BMI value.
         * @param {number} bmi - The BMI value.
         * @returns {string} The BMI category.
         */
        function getBMICategory(bmi) {
            if (bmi < 18.5) {
                return 'Underweight';
            } else if (bmi >= 18.5 && bmi <= 24.9) {
                return 'Normal weight';
            } else if (bmi >= 25 && bmi <= 29.9) {
                return 'Overweight';
            } else {
                return 'Obesity';
            }
        }

        /**
         * Displays the BMI result and category on the UI.
         * NOTE: This function is no longer called by the main calculate button.
         * It's kept here in case you want to re-enable it for other purposes.
         * @param {number} bmi - The calculated BMI.
         * @param {string} category - The BMI category.
         */
        function displayResult(bmi, category) {
            bmiValueSpan.textContent = bmi.toFixed(2); // Display BMI rounded to 2 decimal places
            bmiCategorySpan.textContent = category;
            // resultDiv.classList.remove('hidden'); // This line is commented out to keep it hidden
        }

        /**
         * Shows a message box with an error or information.
         * @param {string} message - The message to display.
         * @param {boolean} isError - True if it's an error message, false otherwise.
         */
        function showMessageBox(message, isError = true) {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden');
            if (isError) {
                messageBox.classList.remove('bg-green-100', 'border-green-200', 'text-green-700');
                messageBox.classList.add('bg-red-100', 'border-red-200', 'text-red-700');
            } else {
                messageBox.classList.remove('bg-red-100', 'border-red-200', 'text-green-700');
                messageBox.classList.add('bg-green-100', 'border-green-200', 'text-green-700');
            }
        }

        /**
         * Hides the message box.
         */
        function hideMessageBox() {
            messageBox.classList.add('hidden');
        }

        /**
         * Saves a new BMI entry to local storage.
         * @param {object} entry - The BMI entry object to save.
         */
        function saveBMIData(entry) {
            let history = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            history.unshift(entry); // Add new entry to the beginning of the array
            localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
        }

        /**
         * Deletes a BMI entry from local storage by its index.
         * @param {number} index - The index of the entry to delete.
         */
        function deleteBMIData(index) {
            let history = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            if (index > -1 && index < history.length) {
                history.splice(index, 1); // Remove the entry at the specified index
                localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
                loadBMIHistory(); // Reload history to update the display
                showMessageBox('Entry deleted successfully!', false);
                setTimeout(() => hideMessageBox(), 3000);
            }
        }

        /**
         * Loads and displays BMI history from local storage.
         */
        function loadBMIHistory() {
            const history = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            historyTableBody.innerHTML = ''; // Clear existing entries

            if (history.length === 0) {
                noHistoryMessage.classList.remove('hidden'); // Show "No history" message
            } else {
                noHistoryMessage.classList.add('hidden'); // Hide "No history" message
                history.forEach((entry, index) => {
                    const row = historyTableBody.insertRow();
                    let heightDisplay;
                    if (entry.heightUnit === 'cm') {
                        heightDisplay = `${entry.heightCm} cm`;
                    } else {
                        heightDisplay = `${entry.heightFt} ft ${entry.heightIn} in`;
                    }

                    row.innerHTML = `
                        <td class="py-2 px-4 text-gray-800">${entry.date}</td>
                        <td class="py-2 px-4 text-gray-800">${entry.userName || 'N/A'}</td>
                        <td class="py-2 px-4 text-gray-800">${entry.userAge || 'N/A'}</td>
                        <td class="py-2 px-4 text-gray-800">${heightDisplay}</td>
                        <td class="py-2 px-4 text-gray-800">${entry.weightKg}</td>
                        <td class="py-2 px-4 text-gray-800 font-semibold">${entry.bmi.toFixed(2)}</td>
                        <td class="py-2 px-4 text-gray-800">${entry.category}</td>
                        <td class="py-2 px-4 text-gray-800">
                            <button class="delete-btn" data-index="${index}">Delete</button>
                            <button class="guide-btn mt-1" data-category="${entry.category}" data-name="${entry.userName || ''}">Health Guide</button>
                        </td>
                    `;
                });

                // Add event listeners to newly created delete buttons
                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const indexToDelete = parseInt(event.target.dataset.index);
                        deleteBMIData(indexToDelete);
                    });
                });

                // Add event listeners to newly created health guide buttons
                document.querySelectorAll('.guide-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const category = event.target.dataset.category;
                        const userName = event.target.dataset.name;
                        // Display the modal and generate guide inside it
                        healthGuideModal.classList.remove('hidden');
                        generateHealthGuide(category, userName);
                    });
                });
            }
        }

        /**
         * Generates a health guide based on BMI category using the Gemini API.
         * @param {string} category - The BMI category (e.g., "Normal weight", "Obesity").
         * @param {string} [userName=''] - Optional user name for personalization.
         */
        async function generateHealthGuide(category, userName = '') {
            modalHealthGuideContent.innerHTML = ''; // Clear previous guide in modal
            modalHealthGuideLoading.classList.remove('hidden'); // Show loading spinner in modal
            viewToggleBtn.classList.add('hidden'); // Hide toggle button initially

            let prompt = `Provide a concise health guide (around 100-150 words) for someone with a BMI category of "${category}". Focus on general advice regarding diet, exercise, and lifestyle. Do not include specific medical advice or disclaimers.`;

            if (userName) {
                prompt = `Hello ${userName}! ${prompt}`;
            }

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = "AIzaSyBcKkdc73vhM-ZuZcxBXbdBmKsDuzfRVOk"; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            let retries = 0;
            const maxRetries = 5;
            let delay = 1000; // 1 second

            while (retries < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429) { // Too Many Requests
                            retries++;
                            await new Promise(res => setTimeout(res, delay));
                            delay *= 2; // Exponential backoff
                            continue;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        fullHealthGuideText = result.candidates[0].content.parts[0].text; // Store full text

                        if (fullHealthGuideText.length > TRUNCATE_LENGTH) {
                            modalHealthGuideContent.textContent = fullHealthGuideText.substring(0, TRUNCATE_LENGTH) + '...';
                            viewToggleBtn.textContent = 'View More';
                            viewToggleBtn.classList.remove('hidden');
                        } else {
                            modalHealthGuideContent.textContent = fullHealthGuideText;
                            viewToggleBtn.classList.add('hidden'); // Hide button if text is short
                        }

                    } else {
                        modalHealthGuideContent.textContent = "Could not generate a health guide at this time. Please try again.";
                        viewToggleBtn.classList.add('hidden');
                    }
                    break; // Exit loop on success
                } catch (error) {
                    modalHealthGuideContent.textContent = "Error generating health guide: " + error.message;
                    viewToggleBtn.classList.add('hidden');
                    break; // Exit loop on unrecoverable error
                } finally {
                    modalHealthGuideLoading.classList.add('hidden'); // Hide loading spinner
                }
            }
            if (retries === maxRetries) {
                modalHealthGuideContent.textContent = "Failed to generate health guide after multiple retries. Please try again later.";
                viewToggleBtn.classList.add('hidden');
            }
        }

        /**
         * Toggles between full and truncated health guide text.
         */
        viewToggleBtn.addEventListener('click', () => {
            if (modalHealthGuideContent.textContent.endsWith('...')) {
                modalHealthGuideContent.textContent = fullHealthGuideText;
                viewToggleBtn.textContent = 'View Less';
            } else {
                modalHealthGuideContent.textContent = fullHealthGuideText.substring(0, TRUNCATE_LENGTH) + '...';
                viewToggleBtn.textContent = 'View More';
            }
        });


        /**
         * Handles the BMI calculation when the button is clicked.
         */
        calculateBtn.addEventListener('click', () => {
            hideMessageBox(); // Hide any previous messages
            resultDiv.classList.add('hidden'); // Ensure the main result div is hidden

            const userName = userNameInput.value.trim(); // Get name and trim whitespace
            const userAge = parseInt(userAgeInput.value); // Get age and parse as integer
            const weightKg = parseFloat(weightInput.value);
            let heightCm;
            let originalHeightValue;
            let originalHeightUnit = heightUnitSelect.value;

            // Validate weight
            if (isNaN(weightKg) || weightKg <= 0) {
                showMessageBox('Please enter a valid positive number for weight.');
                return;
            }

            // Validate age
            if (isNaN(userAge) || userAge <= 0 || userAge > 120) {
                showMessageBox('Please enter a valid age between 1 and 120.');
                return;
            }

            if (originalHeightUnit === 'cm') {
                const hCm = parseFloat(heightCmInput.value);
                if (isNaN(hCm) || hCm <= 0) {
                    showMessageBox('Please enter a valid positive number for height in centimeters.');
                    return;
                }
                heightCm = hCm;
                originalHeightValue = hCm;
            } else { // ft-in
                const feet = parseFloat(heightFtInput.value);
                const inches = parseFloat(heightInInput.value);

                if (isNaN(feet) || feet < 0 || isNaN(inches) || inches < 0 || inches >= 12) {
                    showMessageBox('Please enter valid positive numbers for feet and inches (inches must be less than 12).');
                    return;
                }
                // Convert feet and inches to total centimeters
                heightCm = (feet * 30.48) + (inches * 2.54);
                originalHeightValue = { feet: feet, inches: inches }; // Store original ft/in values
            }

            const bmi = calculateBMI(weightKg, heightCm);
            const category = getBMICategory(bmi);

            // Removed displayResult(bmi, category); call
            // The main result div will remain hidden.

            // Save the current entry to history
            const today = new Date();
            const entryDate = today.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            const newEntry = {
                date: entryDate,
                userName: userName, // Add name to entry
                userAge: userAge,   // Add age to entry
                weightKg: weightKg,
                bmi: bmi,
                category: category,
                heightUnit: originalHeightUnit // Store the unit used
            };

            if (originalHeightUnit === 'cm') {
                newEntry.heightCm = originalHeightValue;
            } else {
                newEntry.heightFt = originalHeightValue.feet;
                newEntry.heightIn = originalHeightValue.inches;
            }

            saveBMIData(newEntry);
            loadBMIHistory(); // Reload history to show the new entry

            // Clear input fields after saving
            userNameInput.value = '';
            userAgeInput.value = '';
            heightCmInput.value = '';
            heightFtInput.value = '';
            heightInInput.value = '';
            weightInput.value = '';
            heightUnitSelect.value = 'cm'; // Reset unit to default
            heightCmContainer.classList.remove('hidden'); // Ensure cm input is visible
            heightFtInContainer.classList.add('hidden'); // Ensure ft/in input is hidden
        });

        /**
         * Clears all BMI history from local storage.
         */
        clearHistoryBtn.addEventListener('click', () => {
            localStorage.removeItem(STORAGE_KEY);
            loadBMIHistory(); // Reload history to show it's empty
            showMessageBox('BMI history cleared!', false); // Show success message
            // Hide message after a few seconds
            setTimeout(() => hideMessageBox(), 3000);
        });

        /**
         * Toggles visibility of height input fields based on selected unit.
         */
        heightUnitSelect.addEventListener('change', () => {
            if (heightUnitSelect.value === 'cm') {
                heightCmContainer.classList.remove('hidden');
                heightFtInContainer.classList.add('hidden');
                // Clear ft/in inputs when switching to cm
                heightFtInput.value = '';
                heightInInput.value = '';
            } else {
                heightCmContainer.classList.add('hidden');
                heightFtInContainer.classList.remove('hidden');
                // Clear cm input when switching to ft/in
                heightCmInput.value = '';
            }
            hideMessageBox(); // Hide any messages when unit changes
        });

        // Event listener for closing the modal
        closeModalBtn.addEventListener('click', () => {
            healthGuideModal.classList.add('hidden');
        });

        // Load history when the page loads
        document.addEventListener('DOMContentLoaded', loadBMIHistory);
    </script>
</body>
</html>